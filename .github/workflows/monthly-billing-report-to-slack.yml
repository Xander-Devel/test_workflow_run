name:   monthly Billing Report to Slack

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  report_billing:
    runs-on: ubuntu-latest

    env:
      ORG_NAME: Xander-Devel

    steps:
      - name: Fetch and Format Billing Data
        id: fetch_data
        env:
          GH_TOKEN: ${{ secrets.BILLING_PAT }}
        run: |
          set -euo pipefail
          RESPONSE=$(curl -sS -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/orgs/$ORG_NAME/settings/billing/actions")

          # Debug: print raw response
          echo "---- Billing API RESPONSE ----"
          echo "$RESPONSE" | jq -r . || echo "$RESPONSE"

          # Fail fast on bad credentials
          if echo "$RESPONSE" | jq -e '.message=="Bad credentials"' >/dev/null; then
            echo "Bad credentials: ensure BILLING_PAT is a classic PAT with read:org, owned by an org owner, and SSO-authorized if needed."
            exit 1
          fi

          TOTAL_MINUTES=$(echo "$RESPONSE" | jq -r '(.total_minutes_used_including_private_repos // .total_minutes_used // 0) | tonumber')
          INCLUDED_MINUTES=$(echo "$RESPONSE" | jq -r '(.included_minutes // 0) | tonumber')
          UBUNTU_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.UBUNTU // 0) | tonumber')
          WINDOWS_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.WINDOWS // 0) | tonumber')
          MACOS_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.MACOS // 0) | tonumber')

          UBUNTU_RATE=0.008
          WINDOWS_RATE=0.016
          MACOS_RATE=0.10

          # Compute estimated cost, subtract an approximate "included credit" using Ubuntu rate
          CURRENT_COST=$(jq -n \
            --argjson ub "$UBUNTU_MIN" \
            --argjson win "$WINDOWS_MIN" \
            --argjson mac "$MACOS_MIN" \
            --argjson inc "$INCLUDED_MINUTES" \
            --arg ubRate "$UBUNTU_RATE" \
            --arg winRate "$WINDOWS_RATE" \
            --arg macRate "$MACOS_RATE" '
              ( $ub * ($ubRate|tonumber)
              + $win * ($winRate|tonumber)
              + $mac * ($macRate|tonumber) )
              - ( $inc * ($ubRate|tonumber) )
            ')

          # Clamp to non-negative and round to whole dollars
          CURRENT_COST_FLOOR=$(echo "$CURRENT_COST" | awk '{ if ($1<0) $1=0; printf("%.0f",$1) }')
          MONTH_LABEL=$(date +%b)

          MESSAGE=$(jq -nr --arg m "$MONTH_LABEL" \
            --arg total "$TOTAL_MINUTES" \
            --arg included "$INCLUDED_MINUTES" \
            --arg ubuntu "$UBUNTU_MIN" \
            --arg windows "$WINDOWS_MIN" \
            --arg macos "$MACOS_MIN" \
            --arg cost "$CURRENT_COST_FLOOR" '
            "GitHub Actions Usage Report (Xander-Devel):
            - Current Month (\($m)): $\($cost)ish
            - Total Minutes: \($total) (Included: \($included))
            - Breakdown â€” Ubuntu: \($ubuntu) min, Windows: \($windows) min, macOS: \($macos) min"
          ')
          SLACK_MESSAGE="${MESSAGE//$'\n'/'\n'}"
          echo "SLACK_MESSAGE=$SLACK_MESSAGE" >> "$GITHUB_OUTPUT"

      # Test-only: print payload instead of sending to Slack
      - name: Print Slack Payload (Test)
        run: |
          echo "---- Slack Payload (Test) ----"
          echo "{\"text\": \"${{ steps.fetch_data.outputs.SLACK_MESSAGE }}\"}"