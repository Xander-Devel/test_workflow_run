name: Monthly Billing Report to Slack

on:
  schedule:
    - cron: '0 9 1 * *'
  workflow_dispatch:

jobs:
  report_billing:
    runs-on: ubuntu-latest

    env:
      ORG_NAME: Xander-Devel

    steps:
      - name: Fetch and Format Billing Data
        id: fetch_data
        env:
          GH_TOKEN: ${{ secrets.BILLING_PAT }}  # classic PAT
        run: |
          set -euo pipefail

          echo "Resolving org and enterprise…"
          ORG_JSON=$(gh api "orgs/$ORG_NAME" || true)
          ORG_TYPE=$(echo "$ORG_JSON" | jq -r '.type // empty')
          ENT_SLUG=$(echo "$ORG_JSON" | jq -r '.enterprise.slug // empty')

          if [ "$ORG_TYPE" != "Organization" ]; then
            echo "ORG_NAME is not an Organization. Found: $ORG_TYPE"
            exit 1
          fi

          if [ -n "$ENT_SLUG" ] && [ "$ENT_SLUG" != "null" ]; then
            echo "Org is enterprise-managed: $ENT_SLUG. Using enterprise billing endpoint."
            RESPONSE=$(curl -sS -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/enterprises/$ENT_SLUG/settings/billing/actions")
          else
            echo "Org is standalone. Using org billing endpoint."
            RESPONSE=$(curl -sS -L \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              "https://api.github.com/orgs/$ORG_NAME/settings/billing/actions")
          fi

          echo "---- Billing API RESPONSE ----"
          echo "$RESPONSE" | jq -r . || echo "$RESPONSE"

          MSG=$(echo "$RESPONSE" | jq -r '.message // empty')
          STATUS=$(echo "$RESPONSE" | jq -r '.status // empty')

          if [ "$MSG" = "Bad credentials" ]; then
            echo "Bad credentials: use a CLASSIC PAT. For org: read:org. For enterprise: read:enterprise. SSO-authorize the PAT if required."
            exit 1
          fi
          if [ "$MSG" = "Not Found" ] || [ "$STATUS" = "404" ]; then
            echo "Not Found: If the org is enterprise-managed, you must query the enterprise endpoint with an enterprise owner PAT (read:enterprise)."
            exit 1
          fi

          TOTAL_MINUTES=$(echo "$RESPONSE" | jq -r '(.total_minutes_used_including_private_repos // .total_minutes_used // 0) | tonumber')
          INCLUDED_MINUTES=$(echo "$RESPONSE" | jq -r '(.included_minutes // 0) | tonumber')
          UBUNTU_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.UBUNTU // 0) | tonumber')
          WINDOWS_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.WINDOWS // 0) | tonumber')
          MACOS_MIN=$(echo "$RESPONSE" | jq -r '(.minutes_used_breakdown.MACOS // 0) | tonumber')

          UBUNTU_RATE=0.008
          WINDOWS_RATE=0.016
          MACOS_RATE=0.10

          CURRENT_COST=$(jq -n \
            --argjson ub "$UBUNTU_MIN" \
            --argjson win "$WINDOWS_MIN" \
            --argjson mac "$MACOS_MIN" \
            --argjson inc "$INCLUDED_MINUTES" \
            --arg ubRate "$UBUNTU_RATE" \
            --arg winRate "$WINDOWS_RATE" \
            --arg macRate "$MACOS_RATE" '
              ( $ub * ($ubRate|tonumber)
              + $win * ($winRate|tonumber)
              + $mac * ($macRate|tonumber) )
              - ( $inc * ($ubRate|tonumber) )
            ')
          CURRENT_COST_FLOOR=$(echo "$CURRENT_COST" | awk '{ if ($1<0) $1=0; printf("%.0f",$1) }')
          MONTH_LABEL=$(date +%b)

          MESSAGE=$(jq -nr --arg m "$MONTH_LABEL" \
            --arg total "$TOTAL_MINUTES" \
            --arg included "$INCLUDED_MINUTES" \
            --arg ubuntu "$UBUNTU_MIN" \
            --arg windows "$WINDOWS_MIN" \
            --arg macos "$MACOS_MIN" \
            --arg cost "$CURRENT_COST_FLOOR" '
            "GitHub Actions Usage Report (Xander-Devel):
            - Current Month (\($m)): $\($cost)ish
            - Total Minutes: \($total) (Included: \($included))
            - Breakdown — Ubuntu: \($ubuntu) min, Windows: \($windows) min, macOS: \($macos) min"
          ')
          SLACK_MESSAGE="${MESSAGE//$'\n'/'\n'}"
          echo "SLACK_MESSAGE=$SLACK_MESSAGE" >> "$GITHUB_OUTPUT"

      - name: Print Slack Payload (Test)
        run: |
          echo "---- Slack Payload (Test) ----"
          echo "{\"text\": \"${{ steps.fetch_data.outputs.SLACK_MESSAGE }}\"}"